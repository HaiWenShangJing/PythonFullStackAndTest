# 系统架构文档

## 架构概览

该应用采用现代全栈架构，结合了异步 Python 后端与交互式前端，并集成了数据库存储和 AI 聊天功能。

### 主要组件
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │ Frontend │ │ Backend │ │ Database │ │ (Streamlit)│<─────>│ (FastAPI) │<─────>│ (PostgreSQL)│ └─────────────┘ └──────┬──────┘ └─────────────┘ │ ▼ ┌─────────────┐ │ AI API │ │(OpenRouter) │ └─────────────┘


## 关键技术

1. **后端**
   - FastAPI: 高性能异步 API 框架
   - SQLAlchemy + asyncpg: 异步 ORM 和数据库驱动
   - Alembic: 数据库迁移管理
   - Pydantic: 数据验证和序列化

2. **前端**
   - Streamlit: 数据应用框架，用于快速构建交互式界面
   - HTTPX: 异步 HTTP 客户端，用于与后端 API 通信

3. **数据存储**
   - PostgreSQL: 关系型数据库，存储应用数据
   - UUID: 用于唯一标识记录

4. **AI 集成**
   - OpenRouter API: 用于访问多种大型语言模型
   - 异步通信: 非阻塞 AI 请求处理

5. **开发与部署**
   - Poetry: 依赖管理
   - Docker + Docker Compose: 容器化与编排
   - GitHub Actions: CI/CD 流程
   - Pytest: 测试框架

## 数据流

### CRUD 操作

1. 用户通过 Streamlit 界面提交表单或点击按钮
2. Streamlit 前端发送 HTTP 请求到 FastAPI 后端
3. FastAPI 处理请求，执行数据库操作
4. PostgreSQL 处理数据并返回结果
5. 响应通过 API 传回前端，更新界面

### AI 聊天流程

1. 用户在聊天界面输入消息
2. 消息通过 API 发送到后端
3. 后端将消息格式化并转发到 OpenRouter API
4. 获取 AI 回复后返回给前端
5. Streamlit 界面更新，显示 AI 回复

## 安全考虑

1. **API 密钥管理**
   - 所有密钥通过环境变量管理，不硬编码
   - 敏感信息不暴露给前端

2. **数据验证**
   - 使用 Pydantic 进行输入验证
   - 参数化 SQL 查询防止注入

3. **错误处理**
   - 全面的异常捕获和处理
   - 向用户提供适当的错误信息

## 扩展性设计

该架构设计为可扩展，未来可以添加以下功能：

1. **用户认证**
   - 已包含 User 模型，可实现 JWT 认证
   - 角色和权限管理

2. **更高级的 AI 功能**
   - 聊天历史持久化
   - 多模型选择
   - 文档索引和检索

3. **监控与遥测**
   - 添加性能监控
   - 用户行为分析
   - 失败请求跟踪

## 部署架构

开发环境:
- Docker Compose 启动所有服务
- 本地卷持久化数据

生产环境:
- Kubernetes 编排 (可选)
- 托管数据库服务
- 负载均衡器和多副本
- 定期备份 